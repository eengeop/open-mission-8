<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê±°ë˜ëŸ‰ ìƒìœ„ 10 ì¢…ëª©</title>
    <style>
        .fav-btn {
            cursor: pointer;
            font-size: 20px;
        }
        .star-on { color: gold; }
        .star-off { color: #bbb; }
    </style>
</head>

<body>

<h1>ğŸ“Š ê±°ë˜ëŸ‰ ìƒìœ„ 10 ì¢…ëª© (AJAX ìë™ ì—…ë°ì´íŠ¸)</h1>

<form method="POST" action="/">
    <label>ìƒˆë¡œê³ ì¹¨ ê°„ê²© (ì´ˆ):</label>
    <input type="number" name="interval" min="1" value="{{ interval }}">
    <button type="submit">ë³€ê²½</button>
</form>

<p>í˜„ì¬ ê°„ê²©: <strong id="cur-interval">{{ interval }}</strong>ì´ˆ</p>

<hr>

<h2>ğŸ“ˆ ì‹¤ì‹œê°„ ì£¼ê°€</h2>

<table border="1" cellpadding="8">
    <thead>
        <tr>
            <th>Fav</th>
            <th>Ticker</th>
            <th>Company</th>
            <th>Price</th>
            <th>Volume</th>
        </tr>
    </thead>

    <tbody id="stocks-table"></tbody>
</table>


<hr>

<h2>â­ ë‚´ ì¦ê²¨ì°¾ê¸° ëª©ë¡</h2>

<table border="1" cellpadding="8">
    <thead>
        <tr>
            <th>Ticker</th>
            <th>Company</th>
        </tr>
    </thead>
    <tbody id="favorites-table"></tbody>
</table>


<script>
    let refreshInterval = {{ interval }} * 1000;
    let favoriteTickers = new Set({{ favorite_tickers|tojson }});

    function renderFavorites() {
        fetch("/api/favorites")
            .then(res => res.json())
            .then(list => {
                let html = "";
                list.forEach(f => {
                    html += `
                        <tr>
                            <td>${f.ticker}</td>
                            <td>${f.company_name}</td>
                        </tr>
                    `;
                });
                document.getElementById("favorites-table").innerHTML = html;
            });
    }

    function toggleFavorite(ticker, company) {
        const isFav = favoriteTickers.has(ticker);

        fetch(isFav ? "/favorite/remove" : "/favorite/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker, company_name: company })
        }).then(() => {
            if (isFav) favoriteTickers.delete(ticker);
            else favoriteTickers.add(ticker);
            fetchStocks();
            renderFavorites();
        });
    }

    function fetchStocks() {
        fetch("/api/stocks")
            .then(res => res.json())
            .then(data => {
                let html = "";

                data.forEach(s => {
                    const isFav = favoriteTickers.has(s.ticker);
                    const starClass = isFav ? "star-on" : "star-off";

                    html += `
                        <tr>
                            <td>
                                <span class="fav-btn ${starClass}"
                                      onclick="toggleFavorite('${s.ticker}', '${s.company_name}')">â˜…</span>
                            </td>
                            <td>${s.ticker}</td>
                            <td>${s.company_name}</td>
                            <td>${s.price}</td>
                            <td>${s.volume}</td>
                        </tr>
                    `;
                });

                document.getElementById("stocks-table").innerHTML = html;
            });
    }

    // ì´ˆê¸° ë¡œë”©
    fetchStocks();
    renderFavorites();

    // ìë™ ê°±ì‹ 
    setInterval(() => {
        fetchStocks();
        renderFavorites();
    }, refreshInterval);

</script>
</body>
</html>
